<p>기획 단계에서 Robospital을 <strong>Python 교육용 게임</strong>으로, <strong>Unity3D</strong>를 이용해 만들기로 결정했다. 따라서 사용자가 게임 안에서 코드를 작성하고, 그 코드를 곧바로 실행할 방법이 필요했다. 또한 warning이나 syntax error 하이라이팅 정보를 받아, 게임 화면에 시각적 피드백을 남길 수 있다면 초보자에게 더 직관적인 피드백을 줄 수 있을 것 같았다. 따라서 Python 코드를 문자열로 받아 Unity3D에서 직접 실행할 수 있는 방법에 대해 탐색하기 시작했다.</p>

<hr />

<h1 id="탐색">탐색</h1>

<p>※ Robospital을 기획하던 2020-2021년 기준으로 작성되었습니다.</p>

<p>Python에 관련된 .NET 라이브러리를 찾기 시작했다. IronPython과 Python.NET을 검토해봤는데, 몇 가지 이유로 선택할 수 없었다.</p>

<ol>
  <li>
    <p>IronPython</p>

    <p>IronPython은 .NET 환경에 맞춘 Python 인터프리터인데, 당시에 Python 2의 지원 중심이었고, Python3의 지원은 느리게 업데이트 되는 중이었다. (현재는 Python 3.4까지 지원하고 있는 것으로 보인다.) 그리고 일부 문법 호환이 완벽하지 않거나, 외부 라이브러리 import가 아쉬운 부분이 있었다.</p>
  </li>
  <li>
    <p>Python.NET</p>

    <p>Pythonnet은 python을 임베딩할 수 있는 라이브러리지만, 당시에는 공식 문서가 직관적이지 않았고, Python 소스 코드를 C#에서 실행하는 예제나 정보가 부족했다. 지금이라면 Pythonnet을 선택할 것 같은데, 당시에는 구현에 대한 확신이 들지 않아서 다른 방법을 찾게 됐다.</p>
  </li>
  <li>
    <p><strong>Python 프로세스 만들어서 통신하기</strong></p>

    <p>결정적으로 라이브러리 위에서 원하는 기능들을 모두 구현할 수 있을 것이라는 확신이 들지 않아서, 새로운 python 프로세스를 만들어, pipe로 통신하는 구조로 만들기로 결정했다. 두 프로세스를 관리해야 한다는 부담은 있었지만, 파이썬 문법이나 코드에 신경을 적게 들일 수 있고, 원하는 기능들을 모두 만들어 낼 수 있을 거라는 확신은 가질 수 있었다.</p>
  </li>
</ol>

<hr />

<h1 id="구현">구현</h1>

<p>“구현”에서는 파이썬 프로세스를 실행하고 Unity에서 Python으로 메시지 (소스 코드)를 전달하는 방법을 다룬다.</p>

<h2 id="파이썬-프로세스-실행-하기">파이썬 프로세스 실행 하기</h2>

<p>Unity C# 스크립트에서 Python 프로세스를 실행하고, stdin, stdout을 연결하는 과정이다.</p>

<p><img src="\assets\images\Unity-Python Integration\image.png" alt="image.png" /></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unity</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PythonInterface</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="n">Process</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
	<span class="k">private</span> <span class="n">StreamWriter</span> <span class="n">stdin</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
	<span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">interfacePath</span> <span class="p">=</span> <span class="s">"interface.py"</span><span class="p">;</span>
	<span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">pythonPath</span> <span class="p">=</span> <span class="s">"python.exe"</span><span class="p">;</span>
	
	<span class="k">private</span> <span class="kt">int</span> <span class="nf">RunCmd</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//error message</span>
			<span class="nf">print</span><span class="p">(</span><span class="s">"python is already running"</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Process</span><span class="p">();</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">pythonPath</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="nf">BuildArgumetns</span><span class="p">();</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardInput</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardError</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">EnableRaisingEvents</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">Exited</span> <span class="p">+=</span> <span class="k">new</span> <span class="nf">EventHandler</span><span class="p">(</span><span class="n">ProcessExited</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">OutputDataReceived</span> <span class="p">+=</span> <span class="k">new</span> <span class="nf">DataReceivedEventHandler</span><span class="p">(</span><span class="n">ReadStdout</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">ErrorDataReceived</span> <span class="p">+=</span> <span class="k">new</span> <span class="nf">DataReceivedEventHandler</span><span class="p">(</span><span class="n">ReadStderr</span><span class="p">);</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">StandardOutputEncoding</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="nf">GetEncoding</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">StandardErrorEncoding</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="nf">GetEncoding</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">);</span>

		<span class="n">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

		<span class="n">stdin</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">StandardInput</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="nf">BeginOutputReadLine</span><span class="p">();</span>
		<span class="n">cmd</span><span class="p">.</span><span class="nf">BeginErrorReadLine</span><span class="p">();</span>

		<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">private</span> <span class="kt">string</span> <span class="nf">BuildArgumetns</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">interfacePath</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="c1">//stdout 콜백</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">ReadStdout</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DataReceivedEventArgs</span> <span class="n">e</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
			<span class="c1">//Do something</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="c1">//stderr 콜백</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">ReadStderr</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DataReceivedEventArgs</span> <span class="n">e</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
			<span class="c1">//Do something</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="c1">//process exit 콜백</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">ProcessExited</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="메시지-박스-만들기">메시지 박스 만들기</h2>

<p>Unity3D에서 MonoBehaviour가 동작하는 메인 스레드는 단일 스레드로 돌아간다. 따라서, MonoBehaviour 내에서 직접적인 멀티스레딩은 지원되지 않는다.</p>

<p>예를 들어, 메인 스레드가 아닌 다른 스레드에서 유니티 GameObject의 속성이나, UI에 접근할 수 없다. 따라서 Python 프로세스에서 온 신호의 콜백이 UI나 GameObject에 영향을 미칠 수 없다.</p>

<p>이 것을 극복하기 위해 사이에 메시지 박스 (Queue)를 두고, 콜백이 메시지를 쌓아두게 한다. 그리고 Unity의 메인 스레드가 주기적으로 메시지 박스를 체크해서 쌓여있는 메시지를 처리하는 방식을 쓴다.</p>

<p><img src="\assets\images\Unity-Python Integration\image%201.png" alt="image.png" /></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unity</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MessageBox</span>
<span class="p">{</span>

	<span class="k">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">messageQueue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

	<span class="k">public</span> <span class="k">void</span> <span class="nf">PushData</span><span class="p">(</span><span class="kt">string</span> <span class="n">data</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">messageQueue</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="kt">string</span> <span class="nf">GetData</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">messageQueue</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">messageQueue</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">public</span> <span class="kt">bool</span> <span class="nf">MessageExisting</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">messageQueue</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="k">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="k">false</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">public</span> <span class="k">void</span> <span class="nf">ClearMessage</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">messageQueue</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unity</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">UnityManager</span><span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
	<span class="c1">//반복하면서 메시지 확인</span>
	<span class="k">virtual</span> <span class="k">public</span> <span class="n">IEnumerator</span> <span class="nf">CheckQueue</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">string</span> <span class="n">data</span> <span class="p">=</span> <span class="n">messageBox</span><span class="p">.</span><span class="nf">GetData</span><span class="p">();</span>
			<span class="n">data</span><span class="p">.</span><span class="nf">DoSomething</span><span class="p">();</span>
			<span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="파이프-연결-코드-전송과-실행">파이프 연결, 코드 전송과 실행</h2>

<p>게임에서 작성한 코드를 파이썬으로 넘기는 과정. 코드를 전달할 파이프를 연결한다.</p>

<p><img src="\assets\images\Unity-Python Integration\image%202.png" alt="image.png" /></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unity</span>
<span class="k">using</span> <span class="nn">TMPro</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO.Pipes</span><span class="p">;</span>

<span class="k">private</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">private</span> <span class="n">TMP_InputField</span> <span class="n">codeEditor</span><span class="p">;</span>
	
	<span class="c1">//코드 파이프 실행</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">RunCodePipeWait</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="kt">string</span> <span class="n">code</span> <span class="p">=</span> <span class="n">codeEditor</span><span class="p">.</span><span class="n">Text</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
		
		<span class="kt">string</span> <span class="n">pipeName</span> <span class="p">=</span> <span class="s">"CodePipe"</span><span class="p">;</span>
		
		<span class="n">codePipe</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NamedPipeServerStream</span><span class="p">(</span><span class="n">pipeName</span><span class="p">);</span>
		<span class="n">codePipe</span><span class="p">.</span><span class="nf">BeginWaitForConnection</span><span class="p">(</span><span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">CodePipeConnectionCallback</span><span class="p">),</span> <span class="n">codePipe</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="c1">//코드 파이프 콜백</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">CodePipeConnectionCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">iar</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BinaryWriter</span> <span class="n">writer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryWriter</span><span class="p">(</span><span class="n">codePipe</span><span class="p">);</span>
		<span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
		<span class="n">buffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="c1">//Argument로 코드 버퍼 길이 전달</span>
	<span class="k">private</span> <span class="kt">string</span> <span class="nf">BuildArgumetns</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">interfacePath</span> <span class="p">+</span> <span class="s">" "</span> <span class="p">+</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
	<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
#파이프에서 코드 읽어오기
</span><span class="k">def</span> <span class="nf">GetCode</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">,</span> <span class="n">pipePath</span><span class="p">):</span>
	<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">pipePath</span><span class="p">,</span> <span class="sh">'</span><span class="s">r+b</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
	<span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
		<span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">pipePath: {pipePath}, bufferSize: {bufferSize}, Error: {err}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">pipePath</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
	<span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">code</span>
	
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	<span class="n">codeBufferSize</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">pipePath</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">pipe</span><span class="se">\\</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">"</span><span class="s">CodePipe</span><span class="sh">"</span>
		
	<span class="n">code</span> <span class="o">=</span> <span class="nc">GetCode</span><span class="p">(</span><span class="n">codeBufferSize</span><span class="p">,</span> <span class="n">pipePath</span><span class="p">)</span>
	<span class="c1">#코드 실행
</span>	<span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
	
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="nf">main</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="클린업-루틴">클린업 루틴</h2>

<p>게임을 종료할 때 파이프와 프로세스를 정리하는 루틴.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Unity</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">CleanCmd</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">controllerCeaning</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">codePipe</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">try</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">codePipe</span><span class="p">.</span><span class="n">IsConnected</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">codePipe</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
		<span class="n">codePipe</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
		<span class="n">codePipe</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
		<span class="n">codePipe</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">try</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(!</span><span class="n">cmd</span><span class="p">.</span><span class="n">HasExited</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cmd</span><span class="p">.</span><span class="nf">Kill</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
		<span class="n">cmd</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
		<span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stdin</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
		<span class="n">stdin</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnApplicationQuit</span><span class="p">()</span>
<span class="p">{</span>
	<span class="nf">CleanController</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div></div>

<hr />

<h1 id="추가적인-기능들">추가적인 기능들</h1>

<p>“추가적인 기능들”에서는 Robospital을 교육용 게임으로 만들기 위해 필요했던 과정을 다룬다. 피드백, 코드 실행 시각화, 변수 추적 등의 기능 추가를 위해 코드를 분석하고, 디버거를 이용하는 방법이 필요했다.</p>

<h2 id="python--unity-시그널-파이프-추가-연결">Python → Unity 시그널 파이프 추가 연결</h2>

<p>몇몇 기능들을 추가하기 위해서, Python에서 Unity로 신호를 전달할 수 있는 추가적인 통신 수단이 필요했다. 기존 코드 파이프를 사용할 수도 있지만, 관리를 용이하게 하기 위해 추가적인 파이프를 하나 연결했다.</p>

<p><img src="\assets\images\Unity-Python Integration\image%203.png" alt="image.png" /></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Unity</span>
	
	<span class="c1">//시그널 파이프 연결</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">RunSignalPipeWait</span><span class="p">(</span><span class="kt">string</span> <span class="n">pipeName</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">signalPipe</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NamedPipeServerStream</span><span class="p">(</span><span class="n">pipeName</span><span class="p">);</span>
		<span class="n">signalPipe</span><span class="p">.</span><span class="nf">BeginWaitForConnection</span><span class="p">(</span><span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">SingalPipeConnectionCallback</span><span class="p">),</span> <span class="n">signalPipe</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="c1">//시그널 파이프가 연결됐을 때 콜백</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">SingalPipeConnectionCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">iar</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="p">{</span>
			<span class="n">NamedPipeServerStream</span> <span class="n">signalPipe</span> <span class="p">=</span> <span class="p">(</span><span class="n">NamedPipeServerStream</span><span class="p">)</span><span class="n">iar</span><span class="p">.</span><span class="n">AsyncState</span><span class="p">;</span>
			<span class="n">signalPipe</span><span class="p">.</span><span class="nf">BeginRead</span><span class="p">(</span><span class="n">buffer2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">signalBufferSize</span><span class="p">,</span> <span class="n">SignalCallback</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="c1">//시그널이 왔을 때 콜백</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">SignalCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">readBytes</span> <span class="p">=</span> <span class="n">signalPipe</span><span class="p">.</span><span class="nf">EndRead</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readBytes</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">string</span> <span class="n">str</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">buffer2</span><span class="p">);</span>
			<span class="c1">//do something</span>
		<span class="p">}</span>
		<span class="n">buffer2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">signalBufferSize</span><span class="p">];</span>
		<span class="n">signalPipe</span><span class="p">.</span><span class="nf">BeginRead</span><span class="p">(</span><span class="n">buffer2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">signalBufferSize</span><span class="p">,</span> <span class="n">SignalCallback</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
	<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
</span>
<span class="c1">#시그널을 보내는 파이프 열기
</span><span class="k">def</span> <span class="nf">WriteToSignalPipe</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">signalPipe</span>
	<span class="n">signalPipe</span><span class="p">.</span><span class="nf">write</span><span class="p">((</span><span class="n">info</span><span class="o">+</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
		
<span class="n">signalPipe</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">SignalPipe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">w+b</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="abatract-syntax-tree-추상-구문-트리-ast-파싱">Abatract Syntax Tree (추상 구문 트리, AST) 파싱</h2>

<p><a href="https://docs.python.org/ko/3.13/library/ast.html">https://docs.python.org/ko/3.13/library/ast.html</a></p>

<p>AST는 Python 소스 코드를 문법 구조에 따라 트리 형태로 표현한 자료구조로, 코드를 분석하거나 검사할 때 사용한다. Robospital에서는 import할 수 있는 모듈을 제한하거나, 연습문제에서 피드백을 주기 위해 코드를 분석하는데 사용했다.</p>

<p>아래 코드는 제한된 import 모듈이 입력됐을 때 메시지를 보내는 파이썬 코드</p>

<p><img src="\assets\images\Unity-Python Integration\image%204.png" alt="image.png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
</span>
<span class="kn">import</span> <span class="n">ast</span>
<span class="kn">import</span> <span class="n">importlib.util</span>

<span class="k">class</span> <span class="nc">NodeTransformer</span><span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
	<span class="n">safeModules</span> <span class="o">=</span> <span class="p">(</span>
		<span class="sh">'</span><span class="s">Safe Module Name 1</span><span class="sh">'</span><span class="p">,</span>
		<span class="sh">'</span><span class="s">Safe Module Name 2</span><span class="sh">'</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="c1">#코드에서 import를 방문했을 때
</span>	<span class="k">def</span> <span class="nf">visit_Import</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">lineno</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="sh">'</span><span class="s">lineno</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="n">names</span><span class="p">:</span>
			<span class="n">exists</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_spec</span><span class="p">(</span><span class="n">alias</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
			<span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">alias</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">safeModules</span><span class="p">:</span>
					<span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ImportError module </span><span class="sh">'</span><span class="s">{name}</span><span class="sh">'</span><span class="s"> is not allowed</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
					<span class="c1">#send message
</span>			<span class="k">else</span><span class="p">:</span>
				<span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ModuleNotFoundError No module named </span><span class="sh">'</span><span class="s">{name}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
				<span class="c1">#send message
</span>		<span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

	<span class="c1">#코드에서 from ... import ... 를 방문했을 때
</span>	<span class="k">def</span> <span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">lineno</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="sh">'</span><span class="s">lineno</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
		<span class="n">exists</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_spec</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">module</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
		<span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">safeModules</span><span class="p">:</span>
				<span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ImportError module </span><span class="sh">'</span><span class="s">{name}</span><span class="sh">'</span><span class="s"> is not allowed</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
				<span class="c1">#send message
</span>		<span class="k">else</span><span class="p">:</span>
			<span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ModuleNotFoundError No module named </span><span class="sh">'</span><span class="s">{name}</span><span class="sh">'"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
			<span class="c1">#send message
</span>		<span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

</code></pre></div></div>

<p>상수에 접근했을 때 정보를 메시지로 보내는 파이썬 코드</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
</span><span class="k">class</span> <span class="nc">NodeTransformer</span><span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="n">NodeTransformer</span><span class="p">):</span>	

	<span class="k">def</span> <span class="nf">visit_Constant</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">lineno</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="sh">'</span><span class="s">lineno</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
		<span class="n">message</span> <span class="o">=</span> <span class="sh">'</span><span class="s">ast constant {lineno} {type} {value}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nf">type</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">node</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
		<span class="c1">#send message
</span>		<span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></div>

<p>AST 파싱 후 코드를 실행하는 파이썬 main 코드</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
</span><span class="kn">import</span> <span class="n">ast</span>
<span class="kn">import</span> <span class="n">ModifiedNodeTransformer</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	<span class="n">codeBufferSize</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">pipePath</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">pipe</span><span class="se">\\</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">"</span><span class="s">CodePipe</span><span class="sh">"</span>
		
	<span class="n">code</span> <span class="o">=</span> <span class="nc">GetCode</span><span class="p">(</span><span class="n">codeBufferSize</span><span class="p">,</span> <span class="n">pipePath</span><span class="p">)</span>
	
	<span class="c1">#노드 파싱
</span>	<span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
	<span class="n">node</span> <span class="o">=</span> <span class="nc">NodeTransformer</span><span class="p">().</span><span class="nf">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
	
	<span class="c1">#ast에서 변경된 코드를 실행
</span>	<span class="n">byte_code</span> <span class="o">=</span> <span class="nf">compile</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sh">"</span><span class="s">fileName</span><span class="sh">"</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">)</span>
	<span class="nf">exec</span><span class="p">(</span><span class="n">byte_code</span><span class="p">)</span>
	
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="nf">main</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
	<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="파이썬-디버거-pdb-연결과-input-함수-조정">파이썬 디버거 pdb 연결과 input 함수 조정</h2>

<p><a href="https://docs.python.org/ko/3.13/library/pdb.html">https://docs.python.org/ko/3.13/library/pdb.html</a></p>

<p>Python은 pdb라는 대화형 소스코드 디버거를 제공한다. 일반적으로 pdb는 터미널 환경에서 사용하기 때문에, 실행 위치나, 변수 값, 함수 호출 등 코드 실행 상태를 UI에 보여주기 어렵다.</p>

<p>따라서 기존 pdb를 상속해서 각종 디버깅 신호를 파이프 메시지로 분리해서 전송했다. 그리고 신호를 받은 Unity에서는 초보자의 이해를 돕기 위해 코드 하이라이트, 변수 탐색기 업데이트 등, 코드의 실행 과정을 모두 시각화 했다.</p>

<p>pdb를 디버거로 사용할 때 문제점은 pdb의 커맨드와 사용자 코드의 print, input을 구분하기 어렵다는 점이다. 따라서, 두 가지 작업이 필요했다.</p>

<ol>
  <li>pdb의 프롬프트 “(pdb)”를 stdout이 아니라, 시그널 파이프를 통해 전달해서, 사용자 코드의 output과 분리한다. pdb의 경우 출력부를 파이프로 변경하는 간단한 변경이 있었다.</li>
  <li>코드에서 input()을 호출할 경우, 시그널 파이프를 통해 input이 들어올 차례임을 Unity에 전달한다.</li>
</ol>

<p><img src="\assets\images\Unity-Python Integration\image%205.png" alt="image.png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
</span>
<span class="kn">import</span> <span class="n">builtins</span>
<span class="kn">from</span> <span class="n">ModifiedPDB</span> <span class="kn">import</span> <span class="n">modified_pdb</span>

<span class="k">class</span> <span class="nc">MoifiedBuiltins</span><span class="p">():</span>	
	<span class="n">new_globals</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
		<span class="c1">#builtins 복사
</span>		<span class="n">modifiedBuiltins</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="n">builtins</span><span class="p">))</span>
		<span class="c1">#input 함수 대체
</span>		<span class="n">modifiedBuiltins</span><span class="p">[</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">_input_</span>
		<span class="c1">#dictinary 생성
</span>		<span class="n">newGlobals</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="n">modifiedBuiltins</span><span class="p">}</span>

<span class="c1">#수정된 input 함수
</span><span class="k">def</span> <span class="nf">_input_</span><span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">):</span>
	<span class="c1">#프롬프트 길이 확인
</span>	<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">input expected at most 1 arguments, got {length}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)))</span>
		
	<span class="c1">#프롬프트 유무에 따라 시그널 보내기
</span>	<span class="k">if</span> <span class="n">prompt</span><span class="p">:</span>
		<span class="nc">WriteToSignalPipe</span><span class="p">(</span><span class="sh">"</span><span class="s">inputWithPrompt</span><span class="sh">"</span><span class="p">)</span>
		<span class="nf">print</span><span class="p">(</span><span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="nc">WriteToSignalPipe</span><span class="p">(</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">)</span>

	<span class="n">val</span> <span class="o">=</span> <span class="nf">input</span><span class="p">()</span>

	<span class="k">return</span> <span class="n">val</span>
	
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	<span class="n">codeBufferSize</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">pipePath</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">pipe</span><span class="se">\\</span><span class="sh">'</span> <span class="o">+</span> <span class="sh">"</span><span class="s">CodePipe</span><span class="sh">"</span>
		
	<span class="n">code</span> <span class="o">=</span> <span class="nc">GetCode</span><span class="p">(</span><span class="n">codeBufferSize</span><span class="p">,</span> <span class="n">pipePath</span><span class="p">)</span>
	
	<span class="n">new_globals</span> <span class="o">=</span> <span class="nc">MoifiedBuiltins</span><span class="p">().</span><span class="n">new_globals</span>
	
	<span class="c1">#일반 코드 실행
</span>	<span class="c1">#exec(code, new_globals)
</span>	
	<span class="c1">#pdb로 코드 실행
</span>	<span class="n">instance</span> <span class="o">=</span> <span class="nf">modified_pdb</span><span class="p">()</span>
	<span class="n">instance</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">new_globals</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="pyflakes-연동">Pyflakes 연동</h2>

<p>Pyflakes는 파이썬 소스 코드에서 기본적인 오류를 찾아주는 분석 도구이다. 유니티 코드 에디터의 수정이 끝난 후 1초 동안 입력이 없으면, 별도의 Python 프로세스를 실행해 Pyflakes로 코드의 오류를 확인했다.</p>

<p>이 경우, 사용자 코드의 output과 Pyflakes의 메시지를 구분 할 필요가 없기 때문에, stdout으로 메시지를 처리하였다. 다만, Pyflakes의 정보를 Unity에서 효과적으로 구분하기 위해 reporter.py파일을 수정하여 메시지 포맷팅을 구현했다.</p>

<p>원래는 에러·경고 메시지를 다국어로 제공하고 싶었지만, 당시 번역의 품질과 유지보수 비용이 커서 영문 메시지로 고정하기로 결정했다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Python
</span>
<span class="k">class</span> <span class="nc">Reporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">Stream</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_stdout</span> <span class="o">=</span> <span class="n">Stream</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_stderr</span> <span class="o">=</span> <span class="n">Stream</span>
        
    <span class="k">def</span> <span class="nf">syntaxError</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_stderr</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">syntaxError:%d:%s</span><span class="se">\n</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">flake</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_stdout</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">warning:</span><span class="sh">"</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_stdout</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
       

<span class="k">def</span> <span class="nf">_makeDefaultReporter</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">
    Make a reporter that can be used when no reporter is specified.
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nc">Reporter</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
</code></pre></div></div>
